<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="utf-8">
    <title>"Go/No-Go Test"</title>
</head>
<body onload="start()">

    <canvas id="canvas" width= "50px" height="50px" style="border:1px solid #000000;">
    </canvas>
    <table id="finalResults"></table><br/>
    <textarea id="filename" rows="1">fileName</textarea><br/>
    <input type="button" id="downloadButton" value="Download Data"/>
    <script type="text/javascript">
    // https://www.w3schools.com/js/js_arrays.asp to add in array elements
    // https://www.w3schools.com/graphics/canvas_clock.asp for all canvas stuff
    var canvas = document.getElementById("canvas");
    var width = window.innerWidth;
    var height = window.innerHeight;

    //sizing the canvas
    canvas.width = 0.8 * width;
    canvas.height = 0.8 * height;
    var ctx = canvas.getContext("2d");
    ctx.font = height *0.05 + "px arial";

    //global variables
    var spaceBarHit = false;
    var counter = 0;
    var totalItterations = 5; //How many times to flash it
    var delayBetween = 2000; //how many mSec to wait between flashing
    var timeToClick = [];
    var stateDisplayed = [];
    var allCounters = [];
    var currentState = "start";
    var testHasStarted = false;
    function start() {
        ctx.textAlign="left";
        ctx.fillText("Press the Space Bar to Start",10,50);
        ctx.fillText("Press Space for Go", 10, 50 + height*0.05 + 2);
        ctx.fillText("Don't Press Space for No-Go", 10, 50 + 2*(height*0.05) + 2);
        var startTime, endTime, state;
        window.addEventListener('keypress', function(e) {
            // can't use the setInterval() function because it's allowed to drift
            // https://stackoverflow.com/questions/29971898/how-to-create-an-accurate-timer-in-javascript
            if (e.keyCode == 32 && !testHasStarted) {
                state = writeRandom();
                startTime = Date.now();
                testHasStarted = true;
            } else if(e.keyCode == 32) {
                if (counter < totalItterations) {
                    endTime = Date.now();
                    //save variables
                    timeToClick[counter] = endTime - startTime;
                    stateDisplayed[counter] = state;
                    allCounters[counter] = counter;
                    //reset for next iteration
                    startTime = endTime;
                    state = writeRandom();
                    counter = counter + 1;
                } else if( counter == totalItterations) {
                    displayStats();
                }
            }
        });
    }

    function displayStats() {
        //If the test has concluded, then make a table of the results
        clearCanvas();
        ctx.fillText("Done", canvas.width/2, canvas.height/2);
        //Put stats in a table
        var table = document.getElementById("finalResults");
        for (var i = (totalItterations - 1); i >= 0; i--) {
            var row = table.insertRow(0);
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);
            cell1.innerHTML = timeToClick[i];
            cell2.innerHTML = stateDisplayed[i];
            cell3.innerHTML = allCounters[i];
        }
    }

    function download(filename, text) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
    }

    // Start file download.
    document.getElementById("downloadButton").addEventListener("click", function(){
        // Generate download of hello.txt file with some content
        var text = "";
        for (var i = 0; i < totalItterations; i++) {
            text = text + timeToClick[i].toString() + ",";
            text = text + stateDisplayed[i].toString() + ",";
            text = text + allCounters[i].toString() + "\n";
        }
        var filename = document.getElementById("filename").value + ".csv";
        download(filename, text);
    }, false);

    function writeRandom() {
        clearCanvas();
        if (Math.random() < 0.5) {
            setTimeout(writeGo(),1000);
            return "Go";
        } else {
            setTimeout(writeNoGo(),1000);
            return "NoGo";
        }
    }
    //clears canvas to write new words on
    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    //draws a green rectangle with text to press space
    function writeGo() {
        clearCanvas();
        drawRectangle("#c1ff80", "Go");
    }

    //draws a red rectangle to not press space bar
    function writeNoGo() {
        clearCanvas();
        drawRectangle("#ff9999", "No-Go");
    }

    function drawRectangle(boxColor, boxText) {
        ctx.fillStyle = boxColor;
        var boxWidth = .25 * width;
        var boxHeight = .25 * height;
        ctx.fillRect((width * .8 - boxWidth)/2, (height * .8 - boxHeight)/2, boxWidth, boxHeight);
        ctx.fillStyle = "black";
        ctx.textAlign = "center";
        ctx.fillText(boxText, (width * .8)/2, (height * .8)/2);
    }
</script>
</body>
</html>
